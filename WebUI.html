<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='UTF-8'>
<title>MDB Cash Changer - Live View</title>
<style>
body { font-family: Arial, sans-serif; background:#f8f8f8; margin:2em; }
table { border-collapse: collapse; width: 100%; margin-top: 1em; background:white; }
th, td { border: 1px solid #ccc; padding: 8px; text-align:center; }
th { background-color:#eee; }
button { padding:6px 10px; background:#0078d7; color:white; border:none; border-radius:5px; cursor:pointer; }
button:hover { background:#005fa3; }
.status-ok { color:green; font-weight:bold; }
.status-full { color:orange; font-weight:bold; }
.status-empty { color:red; font-weight:bold; }
#controls { margin-bottom: 1em; }
input[type='number'] { padding:6px; border:1px solid #ccc; border-radius:4px; }
</style>
</head>
<body>
<h2>MDB Cash Changer - Live View</h2>

<div id='controls'>
    <button onclick='resetTubes()' style='background:#b22222'>Reset All Tubes</button>

    <!-- New dispense amount controls -->
    <span style='margin-left:1em;'>
        <input type='number' id='amountInput' min='1' placeholder='Amount to dispense' />
        <button onclick='dispenseAmount()' style='background:#228B22'>Dispense Amount</button>
    </span>
</div>
<label>
    <input type='checkbox' id='acceptToggle' checked onchange='toggleCoinInput(this.checked)'>
    Accept Coins
</label>


<table id='coinTable'>
<thead><tr><th>Type</th><th>Value</th><th>Count</th><th>Capacity</th><th>Full%</th><th>Status</th><th>Action</th></tr></thead>
<tbody></tbody>
</table>

<script>
let ws = new WebSocket('ws://localhost:8080/ws');
ws.onopen = () => { console.log('WebSocket connected'); ws.send('get_state'); };

ws.onmessage = (msg) => {
    const data = JSON.parse(msg.data);
    if (data.type === 'state') renderTable(data.tubes);
    else if (data.eventType) updateSingle(data);
    else if (data.type === 'reset') ws.send('get_state');
};

function renderTable(tubes) {
    const tbody = document.querySelector('#coinTable tbody');
    tbody.innerHTML = '';
    tubes.forEach(t => {
        const tr = document.createElement('tr');
        const cls = t.Status === 'Full' ? 'status-full' : t.Status === 'Empty' ? 'status-empty' : 'status-ok';
        tr.innerHTML = `
            <td>${t.CoinType}</td>
            <td>${t.Value}</td>
            <td id='count-${t.CoinType}'>${t.Count}</td>
            <td>${t.Capacity}</td>
            <td>${t.FullnessPercent}%</td>
            <td class='${cls}'>${t.Status}</td>
            <td><button onclick='dispense(${t.CoinType})'>Dispense</button></td>`;
        tbody.appendChild(tr);
    });
}

function updateSingle(e) {
    const el = document.getElementById('count-' + e.coinType);
    if (el) el.textContent = e.newCount ?? (parseInt(el.textContent) - (e.quantity || 0));
}

function dispense(type) {
    ws.send(JSON.stringify({ action:'dispense', coinType:type }));
}

function dispenseAmount() {
    const input = document.getElementById('amountInput');
    const val = parseInt(input.value, 10);
    if (!val || val <= 0) {
        alert('Please enter a positive amount to dispense.');
        return;
    }
    ws.send(JSON.stringify({ action:'dispense_amount', amount: val }));
    input.value = '';
}

function resetTubes() {
    if (confirm('Reset all tube counts to 0?')) {
        ws.send(JSON.stringify({ action:'reset' }));
    }
}

function toggleCoinInput(enabled) {
    ws.send(JSON.stringify({ action:'toggle_accept', enabled }));
}

</script>
</body>
</html>